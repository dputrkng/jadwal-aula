<!DOCTYPE html>
<html>
<head>
    <title>Jadwal Pemakaian Ruangan</title>
    <style>
        /* CSS untuk tampilan yang lebih menarik */
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        h1 {
            text-align: center;
        }

        form {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 10px;
            background-color: #f9f9f9;
        }

        label {
            display: block;
            margin-bottom: 10px;
        }

        input, select {
            width: 100%;
            padding: 10px;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        button {
            display: block;
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 5px;
            background-color: #28a745;
            color: white;
            font-size: 16px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
    <h1>Form Jadwal Pemakaian Ruangan</h1>
    <form id="bookingForm">
        <label for="room">Ruangan:</label>
        <input type="text" id="room" name="room" required>
        
        <label for="date">Tanggal:</label>
        <input type="date" id="date" name="date" required>
        
        <label for="startTime">Waktu Mulai:</label>
        <input type="time" id="startTime" name="startTime" required>
        
        <label for="endTime">Waktu Selesai:</label>
        <input type="time" id="endTime" name="endTime" required>
        
        <label for="purpose">Keperluan:</label>
        <input type="text" id="purpose" name="purpose" required>
        
        <label for="bidang">Bidang:</label>
        <select id="bidang" name="bidang" required>
            <option value="CK">CK</option>
            <option value="BM">BM</option>
            <option value="TR">TR</option>
            <option value="Jakon">Jakon</option>
            <option value="SDA">SDA</option>
            <option value="Umum">Umum</option>
            <option value="Keuangan">Keuangan</option>
            <option value="Program">Program</option>
            <option value="Sekret">Sekret</option>
        </select>
        
        <label for="pic">PIC Booking:</label>
        <input type="text" id="pic" name="pic" required>
        
        <button type="submit">Simpan</button>
    </form>

    <h2>Jadwal Pemakaian Ruangan</h2>
    <table id="schedule">
        <thead>
            <tr>
                <th>Tanggal</th>
                <th>Waktu Mulai</th>
                <th>Waktu Selesai</th>
                <th>Ruangan</th>
                <th>Keperluan</th>
                <th>Bidang</th>
                <th>PIC</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>

    <script>
        // Konfigurasi Firebase (ganti dengan konfigurasi Anda sendiri)
        const firebaseConfig = {
            apiKey: "AIzaSyAgRYNgH-3HsnFVuJXAz5AbiBsU-Xe8o2g",
            authDomain: "jadwal-aula.firebaseapp.com",
            projectId: "jadwal-aula",
            storageBucket: "jadwal-aula.appspot.com",
            messagingSenderId: "1075933905095",
            appId: "1:1075933905095:web:c2836158c7d750516ebee2"
        };

        // Inisialisasi Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const form = document.getElementById('bookingForm');
        const scheduleTableBody = document.querySelector('#schedule tbody');

        form.addEventListener('submit', function(event) {
            event.preventDefault();

            const room = form.room.value;
            const date = form.date.value;
            const startTime = form.startTime.value;
            const endTime = form.endTime.value;
            const purpose = form.purpose.value;
            const bidang = form.bidang.value;
            const pic = form.pic.value;

            // Debugging: Log data form submission
            console.log('Form submitted:', { room, date, startTime, endTime, purpose, bidang, pic });

            // Cek bentrok jadwal
            db.collection('bookings')
                .where('room', '==', room)
                .get()
                .then(querySnapshot => {
                    let isConflict = false;

                    querySnapshot.forEach(doc => {
                        const booking = doc.data();

                        // Konversi string ke objek Date
                        const bookingStartDate = new Date(`${booking.date}T${booking.startTime}`);
                        const bookingEndDate = new Date(`${booking.date}T${booking.endTime}`);
                        const newStartDate = new Date(`${date}T${startTime}`);
                        const newEndDate = new Date(`${date}T${endTime}`);

                        // Check if there is a conflict
                        if (
                            (newStartDate < bookingEndDate && newEndDate > bookingStartDate)
                        ) {
                            isConflict = true;
                        }
                    });

                    if (isConflict) {
                        alert('Ruangan sudah terpakai pada waktu tersebut!');
                        location.reload(); // Tambahkan fungsi refresh
                    } else {
                        // Simpan pemesanan ke Firestore
                        db.collection('bookings').add({
                            room, date, startTime, endTime, purpose, bidang, pic
                        }).then(() => {
                            form.reset();
                            updateSchedule();
                            alert('Data berhasil di-entry!');
                        }).catch(error => {
                            console.error('Error adding document: ', error);
                            alert('Terjadi kesalahan saat menyimpan data!');
                        });
                    }
                });
        });

        function updateSchedule() {
            scheduleTableBody.innerHTML = '';
            db.collection('bookings').get().then(querySnapshot => {
                querySnapshot.forEach(doc => {
                    const booking = doc.data();
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${booking.date}</td>
                        <td>${booking.startTime}</td>
                        <td>${booking.endTime}</td>
                        <td>${booking.room}</td>
                        <td>${booking.purpose}</td>
                        <td>${booking.bidang}</td>
                        <td>${booking.pic}</td>
                    `;
                    scheduleTableBody.appendChild(row);
                });
            });
        }

        // Initial call to display bookings
        updateSchedule();

        // Debugging: Verify Firebase initialization
        console.log('Firebase initialized:', firebaseConfig);
    </script>
</body>
</html>
